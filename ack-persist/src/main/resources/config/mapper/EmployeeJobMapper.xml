<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ack.persist.mapper.EmployeeJobLogMapper">
	<resultMap type="org.ack.pojo.EmployeeJobLog" id="employeeJobLogResultMap">
		<result property="id" column="id" />
		<result property="userId" column="userId" />
		<result property="projectTaskId" column="projectTaskId" />
		<result property="departmentId" column="departmentId" />
		<result property="content" column="content" />
		<result property="color" column="color" />
		<result property="cacheStatus" column="cacheStatus" />
		<result property="startTime" column="startTime" />
		<result property="endTime" column="endTime" />
		<result property="createTime" column="createTime" />
	</resultMap>
	
	<resultMap type="org.ack.pojo.EmployeeJobLog" id="logListResulMap" extends="employeeJobLogResultMap">
	    <association property="user" javaType="user">
	         <id property="id" column="userId"/>
	         <result property="surname" column="surname"/>
	         <result property="name" column="name"/>
	    </association>
	    <association property="projectTask" javaType="projectTask">
	         <id property="id" column="projectTaskId"/>
	         <result property="task" column="task"/>
	    </association>
	    <association property="department" javaType="department">
	         <id property="id" column="departmentId"/>
	         <result property="departmentName" column="departmentName"/>
	    </association>
	</resultMap>
     
    <sql id="base_column">
        id,userId,projectTaskId,departmentId,content,color,cacheStatus,startTime,endTime,createTime
    </sql>
    <delete id="deleteById" parameterType="long">
       DELETE FROM ack_employee_job_log
	   WHERE id = #{id}
    </delete>
    
    <delete id="deleteByIds" >
       DELETE FROM ack_employee_job_log
	   WHERE id in
	   <foreach collection="array" item="ids" index="index"
            open="(" close=")" separator=",">
            #{ids}
       </foreach>
    </delete>
    
    <update id="update" parameterType="org.ack.pojo.EmployeeJobLog">
        UPDATE
		ack_employee_job_log ar
		<set>
			<if test="userId != null and userId !=''">
				ar.userId = #{userId},
			</if>
			<if test="projectTaskId != null and projectTaskId !=''">
				ar.projectTaskId = #{projectTaskId},
			</if>
			<if test="departmentId != null and departmentId !=''">
				ar.departmentId = #{departmentId},
			</if>
			<if test="content != null and content !=''">
				ar.content = #{content},
			</if>
			<if test="color != null and color !=''">
				ar.color = #{color},
			</if>
			<if test="cacheStatus != null and cacheStatus !=''">
				ar.cacheStatus = #{cacheStatus},
			</if>
			<if test="startTime != null and startTime !=''">
				ar.startTime = #{startTime},
			</if>
			<if test="endTime != null and endTime !=''">
				ar.endTime = #{endTime},
			</if>
			<if test="createTime != null and createTime !=''">
				ar.createTime = #{createTime},
			</if>
		</set>
		WHERE id = #{id}
    </update>
    
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO
		ack_employee_job_log(userId,projectTaskId,departmentId,content,color,cacheStatus,startTime,endTime,createTime)
		VALUES
		(#{userId}, #{projectTaskId}, #{departmentId}, #{content}, #{color}, #{cacheStatus}, #{startTime}, #{endTime}, #{createTime})
    </insert> 
    
    <select id="findInterceptorPageList" parameterType="org.ack.persist.page.Page"
		resultMap="logListResulMap">
		
		SELECT
			aji.id,
			aji.userId,
			aji.projectTaskId,
			aji.departmentId,
			aji.content,
			aji.color,
			aji.cacheStatus,
			aji.startTime,
			aji.endTime,
			aji.createTime,
			au.surname,
			au.`name`,
		    apt.task,
		    ad.departmentName
		FROM
			ack_employee_job_log aji
		LEFT JOIN ack_user au ON au.id = aji.userId
		LEFT JOIN ack_project_task apt ON apt.id = aji.projectTaskId
		LEFT JOIN ack_department ad ON aji.departmentId = ad.id
		<where>
		     1 = 1
		     <if test="condition.userId != null and condition.userId !=''">
				AND aji.userId = #{condition.userId}
		     </if>
		     <if test="condition.departmentId != null and condition.departmentId !=''">
				AND aji.departmentId=#{condition.departmentId}
		     </if>
		     <if test="condition.cacheStatus != null and condition.cacheStatus !=''">
				AND aji.cacheStatus=#{condition.cacheStatus}
		     </if>
		     <if test="condition.projectTaskId != null and condition.projectTaskId !=''">
				AND aji.projectTaskId=#{condition.projectTaskId}
		     </if>
		     <if test="condition.surname != null and condition.surname !=''">
				AND au.surname=#{condition.surname}
		     </if>
		     <if test="condition.name != null and condition.name !=''">
				AND au.`name`=#{condition.name}
		     </if>
		     <if test="condition.startTime != null and condition.startTime !=''">
				AND aji.startTime &gt;= #{startTime}
		     </if>
		     <if test="condition.endTime != null and condition.endTime !=''">
				AND aji.endTime &lt;= #{endTime}
		     </if>
		     <if test="condition.flag == 1"><!-- 这里查询距离今天7天内的缓存 -->
				AND (TO_DAYS(now()) - TO_DAYS(aji.createTime)) &lt; 8
		     </if>
		</where>
	</select>  

</mapper>